# Mooncake Testing Architecture

> ğŸ“š **Other Docs**: [Index](README.md) | [Quick Reference](quick-reference.md) | [Testing Guide](guide.md) | [Implementation](implementation-summary.md)

## Overview Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mooncake Test Infrastructure                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LOCAL DEVELOPMENT      â”‚  â”‚        CI/CD (GitHub)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Makefile Commands                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚make test  â”‚  â”‚make test-â”‚  â”‚make test-  â”‚  â”‚make test-all-â”‚ â”‚
â”‚  â”‚           â”‚  â”‚quick     â”‚  â”‚docker-all  â”‚  â”‚platforms     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚               â”‚                â”‚
         â–¼             â–¼               â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Native    â”‚  â”‚           Docker Test Matrix                 â”‚
â”‚  Go Tests   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  (10 sec)   â”‚  â”‚ Ubuntu   â”‚ Alpine   â”‚ Debian   â”‚   Fedora    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ 22.04    â”‚ 3.19     â”‚ 12       â”‚   39        â”‚
                 â”‚ 20.04    â”‚          â”‚          â”‚             â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚          â”‚          â”‚          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  test-runner.sh     â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                        â”‚  â”‚ Smoke Tests    â”‚ â”‚
                        â”‚  â”‚ Integration    â”‚ â”‚
                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## CI/CD Pipeline

```
GitHub Push
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Actions Workflow                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JOB: unit-tests (Matrix: 4 platforms)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ubuntu-     â”‚ â”‚ macos-   â”‚ â”‚ macos-13 â”‚ â”‚ windows- â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ latest      â”‚ â”‚ latest   â”‚ â”‚ (Intel)  â”‚ â”‚ latest   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (x86_64)    â”‚ â”‚ (ARM)    â”‚ â”‚          â”‚ â”‚          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JOB: docker-tests (Matrix: 5 distros)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚Ubuntuâ”‚ â”‚Ubuntuâ”‚ â”‚Alpineâ”‚ â”‚Debianâ”‚ â”‚Fedoraâ”‚            â”‚  â”‚
â”‚  â”‚  â”‚22.04 â”‚ â”‚20.04 â”‚ â”‚ 3.19 â”‚ â”‚  12  â”‚ â”‚  39  â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚     â”‚        â”‚        â”‚        â”‚        â”‚                 â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚                      â”‚                                     â”‚  â”‚
â”‚  â”‚              Smoke + Integration                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JOB: integration-tests (Needs: unit-tests)               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚ ubuntu-     â”‚ â”‚ macos-   â”‚ â”‚ windows- â”‚               â”‚  â”‚
â”‚  â”‚  â”‚ latest      â”‚ â”‚ latest   â”‚ â”‚ latest   â”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
    Pass               Pass               Pass
```

## Test Fixture Organization

```
testing/fixtures/
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ smoke/                    # Fast validation (<1 min total)
â”‚   â”‚   â”œâ”€â”€ 001-version-check.yml      # Binary works
â”‚   â”‚   â”œâ”€â”€ 002-simple-file.yml        # File operations
â”‚   â”‚   â”œâ”€â”€ 003-simple-shell.yml       # Shell execution
â”‚   â”‚   â””â”€â”€ 004-simple-vars.yml        # Variables
â”‚   â”‚
â”‚   â””â”€â”€ integration/              # Full features (5-10 min total)
â”‚       â”œâ”€â”€ 010-file-operations.yml    # Complete file workflow
â”‚       â”œâ”€â”€ 020-loops.yml              # Loop iteration
â”‚       â”œâ”€â”€ 030-conditionals.yml       # When conditions
â”‚       â””â”€â”€ 040-shell-commands.yml     # Complex shell
â”‚
â””â”€â”€ templates/
    â””â”€â”€ test-template.j2          # Template rendering test
```

## Docker Test Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Test Process                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Build Binary
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ env GOOS=linux GOARCH=amd64 \              â”‚
â”‚ go build -o out/mooncake-linux-amd64 ./cmd â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
Step 2: Build Docker Image
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ docker build -f testing/docker/ubuntu.      â”‚
â”‚   Dockerfile -t mooncake-test-ubuntu .      â”‚
â”‚                                             â”‚
â”‚ Dockerfile:                                 â”‚
â”‚   - FROM ubuntu:22.04                       â”‚
â”‚   - Install: curl, git, sudo                â”‚
â”‚   - COPY binary â†’ /usr/local/bin/mooncake   â”‚
â”‚   - COPY test-runner.sh â†’ /test-runner.sh  â”‚
â”‚   - COPY fixtures/ â†’ /fixtures/             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
Step 3: Run Tests
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ docker run --rm mooncake-test-ubuntu smoke  â”‚
â”‚                                             â”‚
â”‚ Container executes:                         â”‚
â”‚   /test-runner.sh smoke                     â”‚
â”‚      â†“                                      â”‚
â”‚   For each test in /fixtures/configs/smoke/â”‚
â”‚      mooncake run -c test.yml               â”‚
â”‚      Save results to /workspace/results/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Test Runner Logic

```
test-runner.sh
â”œâ”€â”€ Verify mooncake binary exists
â”œâ”€â”€ Parse TEST_SUITE parameter (smoke|integration|all)
â”‚
â”œâ”€â”€ run_smoke_tests()
â”‚   â”œâ”€â”€ Find all *.yml in /fixtures/configs/smoke/
â”‚   â”œâ”€â”€ For each test:
â”‚   â”‚   â”œâ”€â”€ Run: mooncake run -c test.yml
â”‚   â”‚   â”œâ”€â”€ Capture output to results/
â”‚   â”‚   â”œâ”€â”€ Track pass/fail count
â”‚   â”‚   â””â”€â”€ Print âœ“ or âœ—
â”‚   â””â”€â”€ Return status
â”‚
â”œâ”€â”€ run_integration_tests()
â”‚   â”œâ”€â”€ Find all *.yml in /fixtures/configs/integration/
â”‚   â”œâ”€â”€ For each test:
â”‚   â”‚   â”œâ”€â”€ Run: mooncake run -c test.yml
â”‚   â”‚   â”œâ”€â”€ Capture output to results/
â”‚   â”‚   â”œâ”€â”€ Track pass/fail count
â”‚   â”‚   â””â”€â”€ Print âœ“ or âœ—
â”‚   â””â”€â”€ Return status
â”‚
â””â”€â”€ Exit with appropriate code
```

## Script Orchestration

```
make test-all-platforms
    â”œâ”€â”€ Run native Go tests
    â”‚   â””â”€â”€ go test -v ./...
    â”‚
    â””â”€â”€ Run Docker multi-distro tests
        â””â”€â”€ scripts/test-docker-all.sh
            â”œâ”€â”€ Build Linux binary once
            â”œâ”€â”€ For each distro:
            â”‚   â”œâ”€â”€ scripts/test-docker.sh <distro>
            â”‚   â”‚   â”œâ”€â”€ Build Docker image
            â”‚   â”‚   â””â”€â”€ Run container with test suite
            â”‚   â””â”€â”€ Track pass/fail
            â””â”€â”€ Print summary
```

## Platform Coverage Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Local  â”‚  CI    â”‚ Docker  â”‚ Native       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ubuntu 22.04    â”‚      â”‚      â”‚       â”‚              â”‚
â”‚ Ubuntu 20.04    â”‚      â”‚      â”‚       â”‚              â”‚
â”‚ Alpine 3.19     â”‚      â”‚      â”‚       â”‚              â”‚
â”‚ Debian 12       â”‚      â”‚      â”‚       â”‚              â”‚
â”‚ Fedora 39       â”‚      â”‚      â”‚       â”‚              â”‚
â”‚ macOS (ARM)     â”‚      â”‚      â”‚         â”‚            â”‚
â”‚ macOS (Intel)   â”‚      â”‚      â”‚         â”‚            â”‚
â”‚ Windows         â”‚        â”‚      â”‚         â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
   = Tested
  Local = Developer machine
  CI = GitHub Actions
  Docker = Container-based testing
  Native = Direct OS execution
```

## Test Types and Timing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test Type    â”‚ Count       â”‚ Time    â”‚ Purpose              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Unit         â”‚ Per package â”‚ ~10s    â”‚ Go code validation   â”‚
â”‚ Smoke        â”‚ 4 tests     â”‚ ~30s    â”‚ Basic functionality  â”‚
â”‚ Integration  â”‚ 4 tests     â”‚ ~2-5m   â”‚ Feature validation   â”‚
â”‚ Full Suite   â”‚ All above   â”‚ ~15m    â”‚ Complete validation  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Smoke Tests:
  - Binary execution âœ“
  - File operations âœ“
  - Shell commands âœ“
  - Variables âœ“

Integration Tests:
  - File workflow âœ“
  - Loops âœ“
  - Conditionals âœ“
  - Complex shell âœ“
```

## Directory Structure

```
mooncake/
â”‚
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ ci.yml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º CI/CD configuration
â”‚
â”œâ”€â”€ testing/
â”‚   â”œâ”€â”€ docker/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Dockerfiles (5 distros)
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ test-runner.sh â”€â”€â”€â”€â–º Test orchestration
â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â”œâ”€â”€ configs/
â”‚   â”‚   â”‚   â”œâ”€â”€ smoke/ â”€â”€â”€â”€â”€â”€â”€â”€â–º 4 smoke tests
â”‚   â”‚   â”‚   â””â”€â”€ integration/ â”€â”€â–º 4 integration tests
â”‚   â”‚   â””â”€â”€ templates/ â”€â”€â”€â”€â”€â”€â”€â”€â–º Test templates
â”‚   â”œâ”€â”€ results/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Test outputs (gitignored)
â”‚   â””â”€â”€ README.md â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Testing documentation
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ test-docker.sh â”€â”€â”€â”€â”€â”€â”€â”€â–º Single distro test
â”‚   â”œâ”€â”€ test-docker-all.sh â”€â”€â”€â”€â–º Multi-distro test
â”‚   â”œâ”€â”€ test-all-platforms.sh â”€â–º Complete test suite
â”‚   â””â”€â”€ run-integration-tests.sh â–º Integration runner
â”‚
â”œâ”€â”€ Makefile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Test targets
â””â”€â”€ out/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Compiled binaries
```

## Data Flow

```
Developer
    â”‚
    â”œâ”€â–º Edit Code
    â”‚       â”‚
    â”‚       â–¼
    â”‚   make test â”€â”€â”€â”€â–º go test ./... â”€â”€â”€â”€â–º /
    â”‚
    â”œâ”€â–º make test-quick
    â”‚       â”‚
    â”‚       â”œâ”€â–º Build Linux binary
    â”‚       â”œâ”€â–º Build Docker image (Ubuntu)
    â”‚       â”œâ”€â–º Run smoke tests
    â”‚       â””â”€â–º /
    â”‚
    â”œâ”€â–º make test-all-platforms
    â”‚       â”‚
    â”‚       â”œâ”€â–º go test ./...
    â”‚       â”œâ”€â–º Build Linux binary
    â”‚       â”œâ”€â–º For each distro:
    â”‚       â”‚   â”œâ”€â–º Build image
    â”‚       â”‚   â””â”€â–º Run smoke + integration
    â”‚       â””â”€â–º / Summary
    â”‚
    â””â”€â–º git push
            â”‚
            â–¼
        GitHub Actions
            â”‚
            â”œâ”€â–º unit-tests (4 platforms)
            â”œâ”€â–º docker-tests (5 distros)
            â””â”€â–º integration-tests (3 platforms)
                    â”‚
                    â–¼
                / Status
```

## Success Metrics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Testing Success Criteria               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  âš¡ Fast Feedback                                   â”‚
â”‚    â€¢ Local smoke: < 2 minutes                    â”‚
â”‚    â€¢ CI complete: < 10 minutes                   â”‚
â”‚                                                     â”‚
â”‚  ğŸ” Comprehensive Coverage                          â”‚
â”‚    â€¢ 5 Linux distros tested                      â”‚
â”‚    â€¢ macOS Intel + ARM                           â”‚
â”‚    â€¢ Windows Server                              â”‚
â”‚                                                     â”‚
â”‚  ğŸ‘¨â€ğŸ’» Developer Experience                            â”‚
â”‚    â€¢ Single command testing                      â”‚
â”‚    â€¢ Clear documentation                         â”‚
â”‚    â€¢ Easy to add tests                           â”‚
â”‚                                                     â”‚
â”‚   Quality Assurance                               â”‚
â”‚    â€¢ Unit tests: >60% coverage                   â”‚
â”‚    â€¢ Smoke tests: 4 scenarios                    â”‚
â”‚    â€¢ Integration: 4 workflows                    â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Future Architecture Enhancements

```
Potential Additions:
â”œâ”€â”€ ARM64 Linux Testing
â”‚   â””â”€â”€ Add arm64 Docker builds
â”‚
â”œâ”€â”€ Performance Benchmarking
â”‚   â”œâ”€â”€ Benchmark suite
â”‚   â””â”€â”€ Historical tracking
â”‚
â”œâ”€â”€ Test Result Dashboard
â”‚   â”œâ”€â”€ Web UI for results
â”‚   â””â”€â”€ Trend analysis
â”‚
â””â”€â”€ Extended Platform Support
    â”œâ”€â”€ FreeBSD
    â”œâ”€â”€ OpenBSD
    â””â”€â”€ Additional Linux distros
```

## Key Design Decisions

1. **Docker for Linux** - Portable, reproducible, multi-distro support
2. **Native for macOS** - Simplest, fastest, no containerization overhead
3. **CI-only for Windows** - Avoid VM complexity, sufficient for validation
4. **Two-tier tests** - Smoke (fast feedback) + Integration (thorough)
5. **Parallel execution** - Maximize throughput in CI
6. **Cached layers** - Docker caching for faster rebuilds
7. **Gitignored results** - Keep repo clean, results are ephemeral
8. **Shell scripts** - Portable, easy to debug, no extra dependencies

---

**For detailed usage instructions, see**: `guide.md`
**For quick reference, see**: `quick-reference.md`
