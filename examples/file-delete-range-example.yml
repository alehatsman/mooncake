---
# File Delete Range Examples
# The file_delete_range action deletes text between two anchor patterns in files.
# Supports both literal and regex matching, with inclusive/exclusive deletion modes.

# ============================================================================
# BASIC EXAMPLES
# ============================================================================

- name: "Remove deprecated code block (exclusive)"
  file_delete_range:
    path: "./src/legacy.py"
    start_anchor: "# BEGIN DEPRECATED"
    end_anchor: "# END DEPRECATED"
    inclusive: false  # Keep anchor lines
  # Result: Deletes content between markers, keeps marker comments

- name: "Remove entire section (inclusive)"
  file_delete_range:
    path: "./config.ini"
    start_anchor: "[old_settings]"
    end_anchor: "[/old_settings]"
    inclusive: true  # Delete anchor lines too
  # Result: Removes section markers and all content between them

- name: "Remove script tags with regex"
  file_delete_range:
    path: "./index.html"
    start_anchor: "^<script>$"
    end_anchor: "^</script>$"
    regex: true
    inclusive: true
  # Result: Removes entire <script> blocks

- name: "Remove TODO comments"
  file_delete_range:
    path: "./main.go"
    start_anchor: "// TODO: Start"
    end_anchor: "// TODO: End"
    inclusive: true
  # Result: Deletes TODO sections

- name: "Remove debug code with backup"
  file_delete_range:
    path: "./app.js"
    start_anchor: "// DEBUG START"
    end_anchor: "// DEBUG END"
    inclusive: true
    backup: true
  # Result: Creates app.js.bak before deletion

- name: "Remove specific version code"
  file_delete_range:
    path: "./compatibility.py"
    start_anchor: "# Python 2.x compatibility"
    end_anchor: "# End Python 2.x"
    inclusive: true
  register: cleanup_result

- name: "Remove multi-line comment block"
  file_delete_range:
    path: "./notes.txt"
    start_anchor: "=== OLD NOTES ==="
    end_anchor: "=== END OLD NOTES ==="
    inclusive: false

- name: "Remove regex-matched log sections"
  file_delete_range:
    path: "./output.log"
    start_anchor: "^\\[DEBUG\\].*$"
    end_anchor: "^\\[END DEBUG\\].*$"
    regex: true
    inclusive: true

- name: "Remove conditional compilation block"
  file_delete_range:
    path: "./feature.c"
    start_anchor: "#ifdef OLD_FEATURE"
    end_anchor: "#endif // OLD_FEATURE"
    inclusive: true

# ============================================================================
# PRACTICAL USE CASES
# ============================================================================

# Use Case 1: Clean up generated code sections
- name: "Remove auto-generated API code"
  file_delete_range:
    path: "./api/generated.go"
    start_anchor: "// Code generated by protoc. DO NOT EDIT."
    end_anchor: "// End generated code"
    inclusive: false
    backup: true
  # Use with code regeneration scripts

# Use Case 2: Remove platform-specific code
- name: "Remove Windows-specific code from Linux build"
  file_delete_range:
    path: "./platform.cpp"
    start_anchor: "#ifdef _WIN32"
    end_anchor: "#endif // _WIN32"
    inclusive: true
  when: "{{ os == 'linux' }}"

# Use Case 3: Clean up test data
- name: "Remove test fixtures from production config"
  file_delete_range:
    path: "./config/database.yml"
    start_anchor: "# TEST DATA BEGIN"
    end_anchor: "# TEST DATA END"
    inclusive: true
  when: "{{ environment == 'production' }}"

# Use Case 4: Remove commented-out code
- name: "Remove large commented code blocks"
  file_delete_range:
    path: "./refactored.js"
    start_anchor: "/* OLD IMPLEMENTATION"
    end_anchor: "END OLD IMPLEMENTATION */"
    inclusive: true

# Use Case 5: Remove version-specific imports
- name: "Remove Python 2 compatibility imports"
  file_delete_range:
    path: "./{{ module_name }}.py"
    start_anchor: "# Python 2/3 compatibility"
    end_anchor: "# End compatibility imports"
    inclusive: true
  loop:
    - utils
    - helpers
    - models
  loop_var: module_name

# Use Case 6: Clean up HTML template sections
- name: "Remove admin panel from public template"
  file_delete_range:
    path: "./templates/dashboard.html"
    start_anchor: "<!-- ADMIN ONLY -->"
    end_anchor: "<!-- END ADMIN -->"
    inclusive: true
  when: "{{ user_role != 'admin' }}"

# Use Case 7: Remove experimental features
- name: "Remove beta feature flags"
  file_delete_range:
    path: "./features.toml"
    start_anchor: "[experimental]"
    end_anchor: "[/experimental]"
    inclusive: true
  when: "{{ release_channel == 'stable' }}"

# ============================================================================
# ADVANCED PATTERNS
# ============================================================================

# Pattern 1: Conditional cleanup with result checking
- name: "Remove deprecated API endpoints"
  file_delete_range:
    path: "./api/routes.py"
    start_anchor: "# DEPRECATED ROUTES"
    end_anchor: "# END DEPRECATED"
    inclusive: true
  register: api_cleanup

- name: "Verify routes were cleaned"
  assert:
    file:
      path: "./api/routes.py"
      content_not_contains: "DEPRECATED ROUTES"
  when: api_cleanup.changed

# Pattern 2: Multiple sections with loop
- name: "Remove multiple debug sections"
  file_delete_range:
    path: "./app.py"
    start_anchor: "{{ item.start }}"
    end_anchor: "{{ item.end }}"
    inclusive: true
  loop:
    - { start: "# DEBUG: Auth", end: "# END DEBUG: Auth" }
    - { start: "# DEBUG: Database", end: "# END DEBUG: Database" }
    - { start: "# DEBUG: Cache", end: "# END DEBUG: Cache" }

# Pattern 3: Platform-specific cleanup
- name: "Remove platform-specific sections"
  file_delete_range:
    path: "./cross_platform.c"
    start_anchor: "#ifdef {{ platform }}"
    end_anchor: "#endif // {{ platform }}"
    inclusive: true
  loop:
    - _WIN32
    - __APPLE__
    - __linux__
  loop_var: platform
  when: "platform != target_platform"

# Pattern 4: Regex-based cleanup of dated content
- name: "Remove old version notes"
  file_delete_range:
    path: "./CHANGELOG.md"
    start_anchor: "^## \\[0\\.[0-9]+\\.[0-9]+\\].*$"
    end_anchor: "^---$"
    regex: true
    inclusive: false
  # Removes version 0.x.x changelog entries

# Pattern 5: Safe cleanup with backup and verification
- name: "Remove sensitive data with backup"
  file_delete_range:
    path: "./config.yml"
    start_anchor: "# SENSITIVE"
    end_anchor: "# END SENSITIVE"
    inclusive: true
    backup: true
  register: sensitive_cleanup

- name: "Verify sensitive data removed"
  assert:
    file:
      path: "./config.yml"
      content_not_contains: "password"
  when: sensitive_cleanup.changed

# ============================================================================
# IDEMPOTENCY AND ERROR HANDLING
# ============================================================================

# Idempotent: If range already deleted, reports changed: false
- name: "Ensure deprecated code is removed"
  file_delete_range:
    path: "./legacy.py"
    start_anchor: "# BEGIN DEPRECATED"
    end_anchor: "# END DEPRECATED"
    inclusive: true
  # Safe to run multiple times

# Error handling: Anchors not found
- name: "Try to remove optional section"
  file_delete_range:
    path: "./optional.conf"
    start_anchor: "[optional_feature]"
    end_anchor: "[/optional_feature]"
    inclusive: true
  failed_when: false  # Don't fail if section doesn't exist
  # Note: Currently file_delete_range will error if anchors not found
  # This pattern shows how to handle optional deletions

# ============================================================================
# TEMPLATE VARIABLES
# ============================================================================

- name: "Remove environment-specific configuration"
  file_delete_range:
    path: "{{ config_file }}"
    start_anchor: "# {{ environment }} config"
    end_anchor: "# end {{ environment }}"
    inclusive: true
  vars:
    config_file: "./config/settings.yml"
    environment: "staging"

# ============================================================================
# NOTES
# ============================================================================

# - Always creates backup if backup: true before modification
# - Uses atomic writes (temp file + rename) for safety
# - Supports template variables in path and anchor patterns
# - Returns changed: false if range already deleted or not found (idempotent)
# - Emits EventFileUpdated events for observability
# - Validates path safety (no path traversal attacks)
# - Both anchors must be found or operation fails with error
# - Supports dry-run mode for testing without changes
# - Result data includes: path, deleted_lines, start_anchor, end_anchor
