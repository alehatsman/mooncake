# Assert Action Examples
# Verify system state, command results, file properties, and HTTP responses
#
# Key characteristics:
# - Always returns changed: false (assertions verify, they don't change)
# - Fails fast if verification doesn't pass
# - Provides detailed error messages

# =============================================================================
# Command Assertions
# =============================================================================

- name: "Example 1: Verify command succeeds"
  assert:
    command:
      cmd: "echo 'test'"
      exit_code: 0

- name: "Example 2: Check Docker is installed"
  assert:
    command:
      cmd: "docker --version"
      exit_code: 0

- name: "Example 3: Verify command with specific output"
  assert:
    command:
      cmd: "uname -s"
      exit_code: 0

- name: "Example 4: Check command fails as expected"
  assert:
    command:
      cmd: "grep nonexistent /etc/hosts"
      exit_code: 1

# =============================================================================
# File Assertions
# =============================================================================

- name: "Example 5: Check file exists"
  assert:
    file:
      path: /etc/hosts
      exists: true

- name: "Example 6: Verify file doesn't exist"
  assert:
    file:
      path: /tmp/should-not-exist.txt
      exists: false

- name: "Example 7: Check file contains string"
  assert:
    file:
      path: /etc/hosts
      contains: "localhost"

- name: "Example 8: Verify file permissions"
  assert:
    file:
      path: /etc/hosts
      mode: "0644"

# =============================================================================
# HTTP Assertions
# =============================================================================

- name: "Example 9: Check HTTP endpoint is up"
  assert:
    http:
      url: https://www.example.com
      status: 200

- name: "Example 10: Verify API returns expected content"
  assert:
    http:
      url: https://www.example.com
      status: 200
      contains: "Example Domain"

- name: "Example 11: Check API with custom timeout"
  assert:
    http:
      url: https://www.example.com
      status: 200
      timeout: "30s"

# =============================================================================
# Practical Use Cases
# =============================================================================

# Use Case 1: Verify prerequisites
- name: Check Git installed
  assert:
    command:
      cmd: git --version
      exit_code: 0

- name: Check SSH directory exists
  assert:
    file:
      path: ~/.ssh
      exists: true

- name: Check GitHub is reachable
  assert:
    http:
      url: https://github.com
      status: 200

# Use Case 2: Validate deployment
- name: Check application binary exists
  assert:
    file:
      path: /usr/local/bin/echo
      exists: true

- name: Verify config file has setting (example with /etc/hosts)
  assert:
    file:
      path: /etc/hosts
      contains: "localhost"

# Use Case 3: Security checks
- name: Check /etc/hosts has correct permissions
  assert:
    file:
      path: /etc/hosts
      mode: "0644"

# =============================================================================
# With Variables
# =============================================================================

- vars:
    test_file: /etc/hosts
    search_term: localhost

- name: "Example with variables: Check file"
  assert:
    file:
      path: "{{ test_file }}"
      exists: true

- name: "Example with variables: Verify content"
  assert:
    file:
      path: "{{ test_file }}"
      contains: "{{ search_term }}"

# =============================================================================
# With Result Registration
# =============================================================================

- name: "Register result: Check API"
  assert:
    http:
      url: https://www.example.com
      status: 200
  register: api_check

- name: Display assertion result
  shell: echo "API check - changed={{ api_check.changed }}"
  # Output: API check - changed=false
  # Assertions always report changed=false

# =============================================================================
# Conditional Assertions
# =============================================================================

- name: "Conditional: Check Docker only on Linux"
  assert:
    command:
      cmd: docker --version
      exit_code: 0
  when: os == "linux"

- name: "Conditional: Verify Homebrew only on macOS"
  assert:
    command:
      cmd: brew --version
      exit_code: 0
  when: os == "darwin"

# =============================================================================
# Error Handling Example
# =============================================================================

# Note: This assertion will fail and stop execution
# Uncomment to see fail-fast behavior
#
# - name: "This will fail"
#   assert:
#     file:
#       path: /nonexistent/file.txt
#       exists: true
#
# - name: "This step won't run"
#   shell: echo "Skipped due to assertion failure"

# =============================================================================
# Summary
# =============================================================================
#
# Run this file with:
#   mooncake run --config assert-example.yml
#
# Or in dry-run mode to see what would be checked:
#   mooncake run --dry-run --config assert-example.yml
#
# Key Points:
# - Assertions verify state without changing it (always changed: false)
# - Assertions fail fast - execution stops on first failure
# - Use assertions to validate prerequisites, test deployments, or verify state
# - Three types: command (exit codes), file (content/permissions), http (responses)
