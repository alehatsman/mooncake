{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mooncake.dev/schemas/config.json",
  "title": "Mooncake Configuration Schema",
  "description": "JSON Schema for Mooncake configuration files",
  "type": "array",
  "items": {
    "$ref": "#/definitions/step"
  },
  "definitions": {
    "step": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the step (universal)"
        },
        "when": {
          "type": "string",
          "description": "Conditional expression for step execution (universal)"
        },
        "become": {
          "type": "boolean",
          "description": "Execute with sudo privileges. Works with: shell, file, template"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tags for filtering step execution (universal)"
        },
        "register": {
          "type": "string",
          "description": "Variable name to store step execution result (universal)"
        },
        "with_filetree": {
          "type": "string",
          "description": "Directory path for iterating over files (universal)"
        },
        "with_items": {
          "type": "string",
          "description": "Variable expression for iterating over items (universal)"
        },
        "shell": {
          "type": "string",
          "description": "Shell command to execute"
        },
        "template": {
          "$ref": "#/definitions/template"
        },
        "file": {
          "$ref": "#/definitions/file"
        },
        "include": {
          "type": "string",
          "description": "Path to YAML file with steps to include"
        },
        "include_vars": {
          "type": "string",
          "description": "Path to YAML file with variables to load"
        },
        "vars": {
          "type": "object",
          "description": "Inline variables to set",
          "additionalProperties": true
        },
        "become_user": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: User to become via sudo (e.g., 'root', 'postgres'). Only works with 'shell' action. Ignored for file/template/include."
        },
        "env": {
          "type": "object",
          "description": "⚠️ SHELL ONLY: Environment variables for shell command execution. Ignored for file/template/include.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "cwd": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: Working directory for shell command execution. Ignored for file/template/include."
        },
        "timeout": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: Maximum execution time (e.g., '30s', '5m', '1h'). Only works with 'shell' action. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
        },
        "retries": {
          "type": "integer",
          "description": "⚠️ SHELL ONLY: Number of retry attempts on failure. Only works with 'shell' action. Ignored for file/template/include.",
          "minimum": 0,
          "maximum": 100
        },
        "retry_delay": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: Delay between retry attempts (e.g., '1s', '5s'). Only works with 'shell' action. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
        },
        "changed_when": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: Expression to override 'changed' status (e.g., 'result.rc == 0'). Only works with 'shell' action. Ignored for file/template/include."
        },
        "failed_when": {
          "type": "string",
          "description": "⚠️ SHELL ONLY: Expression to override 'failed' status (e.g., 'result.rc != 0'). Only works with 'shell' action. Ignored for file/template/include."
        }
      },
      "allOf": [
        {
          "if": {
            "not": {
              "required": ["shell"]
            },
            "anyOf": [
              {"required": ["become_user"]},
              {"required": ["env"]},
              {"required": ["cwd"]},
              {"required": ["timeout"]},
              {"required": ["retries"]},
              {"required": ["retry_delay"]},
              {"required": ["changed_when"]},
              {"required": ["failed_when"]}
            ]
          },
          "then": {
            "description": "Warning: Shell-specific fields (become_user, env, cwd, timeout, retries, retry_delay, changed_when, failed_when) are only supported for 'shell' actions and will be ignored for file/template/include operations."
          }
        }
      ],
      "oneOf": [
        {
          "required": ["shell"],
          "not": {
            "anyOf": [
              {"required": ["template"]},
              {"required": ["file"]},
              {"required": ["include"]},
              {"required": ["include_vars"]},
              {"required": ["vars"]}
            ]
          }
        },
        {
          "required": ["template"],
          "not": {
            "anyOf": [
              {"required": ["shell"]},
              {"required": ["file"]},
              {"required": ["include"]},
              {"required": ["include_vars"]},
              {"required": ["vars"]}
            ]
          }
        },
        {
          "required": ["file"],
          "not": {
            "anyOf": [
              {"required": ["shell"]},
              {"required": ["template"]},
              {"required": ["include"]},
              {"required": ["include_vars"]},
              {"required": ["vars"]}
            ]
          }
        },
        {
          "required": ["include"],
          "not": {
            "anyOf": [
              {"required": ["shell"]},
              {"required": ["template"]},
              {"required": ["file"]},
              {"required": ["include_vars"]},
              {"required": ["vars"]}
            ]
          }
        },
        {
          "required": ["include_vars"],
          "not": {
            "anyOf": [
              {"required": ["shell"]},
              {"required": ["template"]},
              {"required": ["file"]},
              {"required": ["include"]},
              {"required": ["vars"]}
            ]
          }
        },
        {
          "required": ["vars"],
          "not": {
            "anyOf": [
              {"required": ["shell"]},
              {"required": ["template"]},
              {"required": ["file"]},
              {"required": ["include"]},
              {"required": ["include_vars"]}
            ]
          }
        }
      ],
      "additionalProperties": false
    },
    "template": {
      "type": "object",
      "required": ["src", "dest"],
      "properties": {
        "src": {
          "type": "string",
          "description": "Source template file path"
        },
        "dest": {
          "type": "string",
          "description": "Destination file path for rendered template"
        },
        "vars": {
          "type": "object",
          "description": "Variables for template rendering",
          "additionalProperties": true
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        }
      },
      "additionalProperties": false
    },
    "file": {
      "type": "object",
      "required": ["path"],
      "properties": {
        "path": {
          "type": "string",
          "description": "File or directory path"
        },
        "state": {
          "type": "string",
          "enum": ["file", "directory", "absent"],
          "description": "Desired state of the file or directory"
        },
        "content": {
          "type": "string",
          "description": "Content to write to the file"
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        }
      },
      "additionalProperties": false
    }
  }
}
