{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mooncake.dev/schemas/config.json",
  "title": "Mooncake Configuration Schema",
  "description": "JSON Schema for Mooncake configuration files",
  "type": "array",
  "items": {
    "$ref": "#/definitions/step"
  },
  "definitions": {
    "step": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the step (universal)"
        },
        "when": {
          "type": "string",
          "description": "Conditional expression for step execution (universal)"
        },
        "creates": {
          "type": "string",
          "description": "Skip step if this file path exists. Useful for idempotency (universal)"
        },
        "unless": {
          "type": "string",
          "description": "Skip step if this command succeeds (exit code 0). Useful for idempotency (universal)"
        },
        "become": {
          "type": "boolean",
          "description": "Execute with sudo privileges. Works with: shell, command, file, template"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tags for filtering step execution (universal)"
        },
        "register": {
          "type": "string",
          "description": "Variable name to store step execution result (universal)"
        },
        "with_filetree": {
          "type": "string",
          "description": "Directory path for iterating over files (universal)"
        },
        "with_items": {
          "type": "string",
          "description": "Variable expression for iterating over items (universal)"
        },
        "shell": {
          "oneOf": [
            {
              "type": "string",
              "description": "Shell command to execute (simple string format)"
            },
            {
              "$ref": "#/definitions/shell_action",
              "description": "Shell command with structured options"
            }
          ],
          "description": "Shell command to execute. Supports both simple string and structured object formats."
        },
        "command": {
          "$ref": "#/definitions/command_action",
          "description": "Direct command execution without shell (safer alternative to shell)"
        },
        "template": {
          "$ref": "#/definitions/template"
        },
        "file": {
          "$ref": "#/definitions/file"
        },
        "copy": {
          "$ref": "#/definitions/copy"
        },
        "unarchive": {
          "$ref": "#/definitions/unarchive"
        },
        "download": {
          "$ref": "#/definitions/download"
        },
        "service": {
          "$ref": "#/definitions/service"
        },
        "include": {
          "type": "string",
          "description": "Path to YAML file with steps to include"
        },
        "include_vars": {
          "type": "string",
          "description": "Path to YAML file with variables to load"
        },
        "vars": {
          "type": "object",
          "description": "Inline variables to set",
          "additionalProperties": true
        },
        "become_user": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: User to become via sudo (e.g., 'root', 'postgres'). Works with 'shell' and 'command' actions. Ignored for file/template/include."
        },
        "env": {
          "type": "object",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Environment variables for shell command execution. Ignored for file/template/include.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "cwd": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Working directory for shell command execution. Ignored for file/template/include."
        },
        "timeout": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Maximum execution time (e.g., '30s', '5m', '1h'). Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|\u00b5s|ms|s|m|h)$"
        },
        "retries": {
          "type": "integer",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Number of retry attempts on failure. Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "minimum": 0,
          "maximum": 100
        },
        "retry_delay": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Delay between retry attempts (e.g., '1s', '5s'). Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|\u00b5s|ms|s|m|h)$"
        },
        "changed_when": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Expression to override 'changed' status (e.g., 'result.rc == 0'). Works with 'shell' and 'command' actions. Ignored for file/template/include."
        },
        "failed_when": {
          "type": "string",
          "description": "\u26a0\ufe0f SHELL/COMMAND ONLY: Expression to override 'failed' status (e.g., 'result.rc != 0'). Works with 'shell' and 'command' actions. Ignored for file/template/include."
        }
      },
      "allOf": [
        {
          "if": {
            "not": {
              "anyOf": [
                {
                  "required": [
                    "shell"
                  ]
                },
                {
                  "required": [
                    "command"
                  ]
                }
              ]
            },
            "anyOf": [
              {
                "required": [
                  "become_user"
                ]
              },
              {
                "required": [
                  "env"
                ]
              },
              {
                "required": [
                  "cwd"
                ]
              },
              {
                "required": [
                  "timeout"
                ]
              },
              {
                "required": [
                  "retries"
                ]
              },
              {
                "required": [
                  "retry_delay"
                ]
              },
              {
                "required": [
                  "changed_when"
                ]
              },
              {
                "required": [
                  "failed_when"
                ]
              }
            ]
          },
          "then": {
            "description": "Warning: Shell-specific fields (become_user, env, cwd, timeout, retries, retry_delay, changed_when, failed_when) are only supported for 'shell' actions and will be ignored for file/template/include operations."
          }
        }
      ],
      "oneOf": [
        {
          "required": [
            "shell"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "command"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "template"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "file"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "copy"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "unarchive"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "download"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "service"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "include"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "include_vars"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "vars"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "file"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "include"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              }
            ]
          }
        }
      ],
      "additionalProperties": false
    },
    "shell_action": {
      "type": "object",
      "required": [
        "cmd"
      ],
      "properties": {
        "cmd": {
          "type": "string",
          "description": "Shell command to execute"
        },
        "interpreter": {
          "type": "string",
          "enum": [
            "bash",
            "sh",
            "pwsh",
            "cmd"
          ],
          "description": "Shell interpreter to use (default: bash on Unix, pwsh on Windows)"
        },
        "stdin": {
          "type": "string",
          "description": "Input to pipe into the command"
        },
        "capture": {
          "type": "boolean",
          "description": "Whether to capture command output (default: true)"
        }
      },
      "additionalProperties": false
    },
    "command_action": {
      "type": "object",
      "required": [
        "argv"
      ],
      "properties": {
        "argv": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Command and arguments as array (e.g., ['git', 'clone', 'url'])"
        },
        "stdin": {
          "type": "string",
          "description": "Input to pipe into the command"
        },
        "capture": {
          "type": "boolean",
          "description": "Whether to capture command output (default: true)"
        }
      },
      "additionalProperties": false
    },
    "template": {
      "type": "object",
      "required": [
        "src",
        "dest"
      ],
      "properties": {
        "src": {
          "type": "string",
          "description": "Source template file path"
        },
        "dest": {
          "type": "string",
          "description": "Destination file path for rendered template"
        },
        "vars": {
          "type": "object",
          "description": "Variables for template rendering",
          "additionalProperties": true
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        }
      },
      "additionalProperties": false
    },
    "file": {
      "type": "object",
      "required": [
        "path"
      ],
      "properties": {
        "path": {
          "type": "string",
          "description": "File or directory path"
        },
        "state": {
          "type": "string",
          "enum": [
            "file",
            "directory",
            "absent",
            "link",
            "hardlink",
            "touch",
            "perms"
          ],
          "description": "Desired state: file (create/update), directory (create), absent (remove), link (symlink), hardlink, touch (update timestamp), perms (change permissions only)"
        },
        "content": {
          "type": "string",
          "description": "Content to write to the file (for state: file)"
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        },
        "owner": {
          "type": "string",
          "description": "File owner username or UID"
        },
        "group": {
          "type": "string",
          "description": "File group name or GID"
        },
        "src": {
          "type": "string",
          "description": "Source path for link/hardlink operations"
        },
        "force": {
          "type": "boolean",
          "description": "Force overwrite existing files or remove non-empty directories"
        },
        "recurse": {
          "type": "boolean",
          "description": "Apply permissions recursively for directories (with state: perms)"
        },
        "backup": {
          "type": "boolean",
          "description": "Create .bak backup before overwriting files"
        }
      },
      "additionalProperties": false
    },
    "copy": {
      "type": "object",
      "required": [
        "src",
        "dest"
      ],
      "properties": {
        "src": {
          "type": "string",
          "description": "Source file path"
        },
        "dest": {
          "type": "string",
          "description": "Destination file path"
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        },
        "owner": {
          "type": "string",
          "description": "File owner username or UID"
        },
        "group": {
          "type": "string",
          "description": "File group name or GID"
        },
        "backup": {
          "type": "boolean",
          "description": "Create .bak backup before overwriting"
        },
        "force": {
          "type": "boolean",
          "description": "Force overwrite if destination exists"
        },
        "checksum": {
          "type": "string",
          "description": "Expected SHA256 or MD5 checksum for verification"
        }
      },
      "additionalProperties": false
    },
    "unarchive": {
      "type": "object",
      "required": [
        "src",
        "dest"
      ],
      "properties": {
        "src": {
          "type": "string",
          "description": "Source archive path (.tar.gz, .zip, etc.)"
        },
        "dest": {
          "type": "string",
          "description": "Destination directory for extraction"
        },
        "strip_components": {
          "type": "integer",
          "description": "Number of leading path components to strip during extraction",
          "minimum": 0
        },
        "creates": {
          "type": "string",
          "description": "Skip extraction if this path exists (idempotency marker)"
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "Directory mode in octal format (e.g., 0755)"
        }
      },
      "additionalProperties": false
    },
    "download": {
      "type": "object",
      "required": [
        "url",
        "dest"
      ],
      "properties": {
        "url": {
          "type": "string",
          "description": "Remote URL to download from"
        },
        "dest": {
          "type": "string",
          "description": "Destination file path"
        },
        "checksum": {
          "type": "string",
          "description": "Expected SHA256 (64 chars) or MD5 (32 chars) checksum for verification and idempotency"
        },
        "mode": {
          "type": "string",
          "pattern": "^0[0-7]{3}$",
          "description": "File mode in octal format (e.g., 0644)"
        },
        "timeout": {
          "type": "string",
          "pattern": "^[0-9]+(ns|us|\u00b5s|ms|s|m|h)$",
          "description": "Maximum download time (e.g., '30s', '5m', '1h')"
        },
        "force": {
          "type": "boolean",
          "description": "Force re-download even if destination exists"
        },
        "backup": {
          "type": "boolean",
          "description": "Create .bak backup before overwriting"
        },
        "headers": {
          "type": "object",
          "description": "Custom HTTP headers (e.g., Authorization, User-Agent)",
          "additionalProperties": {
            "type": "string"
          }
        },
        "retries": {
          "type": "integer",
          "description": "Number of retry attempts on download failure",
          "minimum": 0,
          "maximum": 100
        }
      },
      "additionalProperties": false
    },
    "service": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Service name (systemd: nginx, launchd: com.example.app)"
        },
        "state": {
          "type": "string",
          "enum": [
            "started",
            "stopped",
            "restarted",
            "reloaded"
          ],
          "description": "Desired service state"
        },
        "enabled": {
          "type": "boolean",
          "description": "Enable service to start on boot (systemd: enable/disable, launchd: bootstrap/bootout)"
        },
        "daemon_reload": {
          "type": "boolean",
          "description": "Run 'systemctl daemon-reload' after unit file changes (systemd only)"
        },
        "unit": {
          "type": "object",
          "properties": {
            "dest": {
              "type": "string",
              "description": "Destination path for unit/plist file (default: /etc/systemd/system/<name>.service or ~/Library/LaunchAgents/<name>.plist)"
            },
            "content": {
              "type": "string",
              "description": "Inline unit/plist file content (supports templates)"
            },
            "src_template": {
              "type": "string",
              "description": "Path to unit/plist template file"
            },
            "mode": {
              "type": "string",
              "pattern": "^[0-7]{3,4}$",
              "description": "File permissions (e.g., '0644')"
            }
          },
          "additionalProperties": false
        },
        "dropin": {
          "type": "object",
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "type": "string",
              "description": "Drop-in file name (e.g., '10-override.conf') - systemd only"
            },
            "content": {
              "type": "string",
              "description": "Inline drop-in content (supports templates)"
            },
            "src_template": {
              "type": "string",
              "description": "Path to drop-in template file"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  }
}