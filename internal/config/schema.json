{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mooncake.dev/schemas/config.json",
  "title": "Mooncake Configuration Schema",
  "description": "JSON Schema for Mooncake configuration files",
  "type": "array",
  "items": {
    "$ref": "#/definitions/step"
  },
  "definitions": {
    "assert": {
      "type": "object",
      "description": "Verify conditions without changing system state",
      "properties": {
        "command": {
          "type": "object",
          "properties": {
            "cmd": {
              "type": "string"
            },
            "exit_code": {
              "type": "integer"
            }
          },
          "required": [
            "cmd"
          ],
          "additionalProperties": false
        },
        "file": {
          "type": "object",
          "properties": {
            "contains": {
              "type": "string"
            },
            "content": {
              "type": "string"
            },
            "exists": {
              "type": "boolean"
            },
            "group": {
              "type": "string"
            },
            "mode": {
              "type": "string",
              "pattern": "^[0-7]{3,4}$"
            },
            "owner": {
              "type": "string"
            },
            "path": {
              "type": "string"
            }
          },
          "required": [
            "path"
          ],
          "additionalProperties": false
        },
        "http": {
          "type": "object",
          "properties": {
            "body": {
              "type": "string"
            },
            "body_equals": {
              "type": "string"
            },
            "contains": {
              "type": "string"
            },
            "headers": {
              "type": "object",
              "additionalProperties": true
            },
            "jsonpath": {
              "type": "string"
            },
            "jsonpath_value": {},
            "method": {
              "type": "string"
            },
            "status": {
              "type": "integer"
            },
            "timeout": {
              "type": "string",
              "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
            },
            "url": {
              "type": "string"
            }
          },
          "required": [
            "url"
          ],
          "additionalProperties": false
        }
      },
      "additionalProperties": false,
      "x-category": "system",
      "x-supports-dry-run": true
    },
    "command": {
      "type": "object",
      "description": "Execute commands directly without shell interpolation",
      "properties": {
        "argv": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "capture": {
          "type": "boolean"
        },
        "stdin": {
          "type": "string"
        }
      },
      "required": [
        "argv"
      ],
      "additionalProperties": false,
      "x-category": "command",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0"
    },
    "command_action": {
      "type": "object",
      "description": "Execute commands directly without shell interpolation",
      "properties": {
        "argv": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "capture": {
          "type": "boolean"
        },
        "stdin": {
          "type": "string"
        }
      },
      "required": [
        "argv"
      ],
      "additionalProperties": false,
      "x-category": "command",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0"
    },
    "copy": {
      "type": "object",
      "description": "Copy files with checksum verification and atomic writes",
      "properties": {
        "backup": {
          "type": "boolean"
        },
        "checksum": {
          "type": "string"
        },
        "dest": {
          "type": "string"
        },
        "force": {
          "type": "boolean"
        },
        "group": {
          "type": "string"
        },
        "mode": {
          "type": "string",
          "pattern": "^[0-7]{3,4}$"
        },
        "owner": {
          "type": "string"
        },
        "src": {
          "type": "string"
        }
      },
      "required": [
        "src",
        "dest"
      ],
      "additionalProperties": false,
      "x-implements-check": true,
      "x-category": "file",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "file.copied"
      ]
    },
    "download": {
      "type": "object",
      "description": "Download files from URLs with checksum verification",
      "properties": {
        "backup": {
          "type": "boolean"
        },
        "checksum": {
          "type": "string"
        },
        "dest": {
          "type": "string"
        },
        "force": {
          "type": "boolean"
        },
        "headers": {
          "type": "object",
          "additionalProperties": true
        },
        "mode": {
          "type": "string",
          "pattern": "^[0-7]{3,4}$"
        },
        "retries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "timeout": {
          "type": "string",
          "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
        },
        "url": {
          "type": "string"
        }
      },
      "required": [
        "url",
        "dest"
      ],
      "additionalProperties": false,
      "x-implements-check": true,
      "x-category": "network",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "file.downloaded"
      ]
    },
    "file": {
      "type": "object",
      "description": "Manage files, directories, links, and permissions",
      "properties": {
        "backup": {
          "type": "boolean"
        },
        "content": {
          "type": "string"
        },
        "force": {
          "type": "boolean"
        },
        "group": {
          "type": "string",
          "description": "File group (groupname or GID)"
        },
        "mode": {
          "type": "string",
          "description": "File permissions (e.g., '0644', '0755')",
          "pattern": "^[0-7]{3,4}$"
        },
        "owner": {
          "type": "string",
          "description": "File owner (username or UID)"
        },
        "path": {
          "type": "string",
          "description": "File, directory, or symlink path (required)"
        },
        "recurse": {
          "type": "boolean"
        },
        "src": {
          "type": "string"
        },
        "state": {
          "type": "string",
          "description": "Desired file state (present: file exists, absent: removed, directory: dir exists, link: symlink, touch: update timestamp)",
          "enum": [
            "present",
            "absent",
            "directory",
            "link",
            "touch"
          ]
        }
      },
      "required": [
        "path"
      ],
      "additionalProperties": false,
      "x-implements-check": true,
      "x-category": "file",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "file.created",
        "file.updated",
        "file.removed",
        "directory.created",
        "directory.removed",
        "link.created",
        "permissions.changed"
      ]
    },
    "include_vars": {
      "type": "string",
      "description": "Load variables from a YAML file",
      "additionalProperties": false,
      "x-category": "data",
      "x-supports-dry-run": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "variables.loaded"
      ]
    },
    "package": {
      "type": "object",
      "description": "Manage system packages (install/remove/update)",
      "properties": {
        "extra": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "manager": {
          "type": "string",
          "description": "Package manager (auto-detected if empty: apt, dnf, yum, pacman, zypper, apk, brew, port, choco, scoop)"
        },
        "name": {
          "type": "string",
          "description": "Package name (single package)"
        },
        "names": {
          "type": "array",
          "description": "Multiple packages to install/remove",
          "items": {
            "type": "string"
          }
        },
        "state": {
          "type": "string",
          "description": "Package state (present: installed, absent: removed, latest: install or upgrade)",
          "enum": [
            "present",
            "absent",
            "latest"
          ]
        },
        "update_cache": {
          "type": "boolean",
          "description": "Update package cache before operation (e.g., apt-get update)"
        },
        "upgrade": {
          "type": "boolean"
        }
      },
      "additionalProperties": false,
      "x-platforms": [
        "linux",
        "darwin",
        "windows",
        "freebsd"
      ],
      "x-requires-sudo": true,
      "x-implements-check": true,
      "x-category": "system",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "package.managed"
      ]
    },
    "preset": {
      "type": "object",
      "description": "Execute a preset by expanding it into steps",
      "properties": {
        "name": {
          "type": "string"
        },
        "with": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "x-category": "system",
      "x-supports-dry-run": true
    },
    "print": {
      "type": "object",
      "description": "Display messages to the user",
      "properties": {
        "msg": {
          "type": "string"
        }
      },
      "additionalProperties": false,
      "x-category": "output",
      "x-supports-dry-run": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "print.message"
      ]
    },
    "service": {
      "type": "object",
      "description": "Manage services across platforms (systemd, launchd, Windows)",
      "properties": {
        "daemon_reload": {
          "type": "boolean",
          "description": "Run 'systemctl daemon-reload' after unit file changes (systemd only)"
        },
        "dropin": {
          "type": "object",
          "properties": {
            "content": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "src_template": {
              "type": "string"
            }
          },
          "required": [
            "name"
          ],
          "additionalProperties": false
        },
        "enabled": {
          "type": "boolean",
          "description": "Enable service to start on boot (systemd: enable/disable, launchd: bootstrap/bootout)"
        },
        "name": {
          "type": "string",
          "description": "Service name (systemd: nginx, launchd: com.example.app)"
        },
        "state": {
          "type": "string",
          "description": "Desired service state",
          "enum": [
            "started",
            "stopped",
            "restarted",
            "reloaded"
          ]
        },
        "unit": {
          "type": "object",
          "properties": {
            "content": {
              "type": "string"
            },
            "dest": {
              "type": "string"
            },
            "mode": {
              "type": "string",
              "pattern": "^[0-7]{3,4}$"
            },
            "src_template": {
              "type": "string"
            }
          },
          "additionalProperties": false
        }
      },
      "required": [
        "name"
      ],
      "additionalProperties": false,
      "x-platforms": [
        "linux",
        "darwin",
        "windows"
      ],
      "x-requires-sudo": true,
      "x-implements-check": true,
      "x-category": "system",
      "x-supports-dry-run": true
    },
    "shell": {
      "type": "object",
      "description": "Execute shell commands",
      "properties": {
        "capture": {
          "type": "boolean",
          "description": "Capture command output (default: true). When false, output is only streamed"
        },
        "cmd": {
          "type": "string",
          "description": "Shell command to execute (required)"
        },
        "interpreter": {
          "type": "string",
          "description": "Shell interpreter (bash, sh, pwsh, cmd). Default: bash on Unix, pwsh on Windows",
          "enum": [
            "bash",
            "sh",
            "pwsh",
            "cmd"
          ]
        },
        "stdin": {
          "type": "string",
          "description": "Input to provide to the command via stdin"
        }
      },
      "additionalProperties": false,
      "x-category": "command",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "step.stdout",
        "step.stderr"
      ]
    },
    "shell_action": {
      "type": "object",
      "description": "Execute shell commands",
      "properties": {
        "capture": {
          "type": "boolean",
          "description": "Capture command output (default: true). When false, output is only streamed"
        },
        "cmd": {
          "type": "string",
          "description": "Shell command to execute (required)"
        },
        "interpreter": {
          "type": "string",
          "description": "Shell interpreter (bash, sh, pwsh, cmd). Default: bash on Unix, pwsh on Windows",
          "enum": [
            "bash",
            "sh",
            "pwsh",
            "cmd"
          ]
        },
        "stdin": {
          "type": "string",
          "description": "Input to provide to the command via stdin"
        }
      },
      "additionalProperties": false,
      "x-category": "command",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "step.stdout",
        "step.stderr"
      ]
    },
    "step": {
      "type": "object",
      "properties": {
        "assert": {
          "description": "Verify conditions without changing system state",
          "$ref": "#/definitions/assert"
        },
        "become": {
          "type": "boolean",
          "description": "Execute with sudo privileges. Works with: shell, command, file, template"
        },
        "become_user": {
          "type": "string",
          "description": "⚠️ SHELL/COMMAND ONLY: User to become via sudo (e.g., 'root', 'postgres'). Works with 'shell' and 'command' actions. Ignored for file/template/include."
        },
        "changed_when": {
          "type": "string",
          "description": "Expression to override changed result"
        },
        "command": {
          "description": "Execute commands directly without shell interpolation",
          "$ref": "#/definitions/command"
        },
        "copy": {
          "description": "Copy files with checksum verification and atomic writes",
          "$ref": "#/definitions/copy"
        },
        "creates": {
          "type": "string",
          "description": "Skip step if this file path exists. Useful for idempotency (universal)"
        },
        "cwd": {
          "type": "string",
          "description": "Working directory for the step"
        },
        "download": {
          "description": "Download files from URLs with checksum verification",
          "$ref": "#/definitions/download"
        },
        "env": {
          "type": "object",
          "description": "Environment variables for the step",
          "additionalProperties": true
        },
        "failed_when": {
          "type": "string",
          "description": "Expression to override failure condition"
        },
        "file": {
          "description": "Manage files, directories, links, and permissions",
          "$ref": "#/definitions/file"
        },
        "include": {
          "type": "string",
          "description": "Path to YAML file with steps to include"
        },
        "include_vars": {
          "description": "Load variables from YAML files",
          "$ref": "#/definitions/include_vars"
        },
        "name": {
          "type": "string",
          "description": "Name of the step (universal)"
        },
        "package": {
          "description": "Manage system packages (install/remove/update)",
          "$ref": "#/definitions/package"
        },
        "preset": {
          "description": "Execute a preset by expanding it into steps",
          "oneOf": [
            {
              "type": "string",
              "description": "preset (simple string format)"
            },
            {
              "description": "preset (structured object format)",
              "$ref": "#/definitions/preset"
            }
          ]
        },
        "print": {
          "description": "Display messages to the user",
          "$ref": "#/definitions/print"
        },
        "register": {
          "type": "string",
          "description": "Variable name to store step execution result (universal)"
        },
        "retries": {
          "type": "integer",
          "description": "⚠️ SHELL/COMMAND ONLY: Number of retry attempts on failure. Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "minimum": 0,
          "maximum": 100
        },
        "retry_delay": {
          "type": "string",
          "description": "⚠️ SHELL/COMMAND ONLY: Delay between retry attempts (e.g., '1s', '5s'). Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
        },
        "service": {
          "description": "Manage services across platforms (systemd, launchd, Windows)",
          "$ref": "#/definitions/service"
        },
        "shell": {
          "description": "Execute shell commands",
          "oneOf": [
            {
              "type": "string",
              "description": "shell (simple string format)"
            },
            {
              "description": "shell (structured object format)",
              "$ref": "#/definitions/shell"
            }
          ]
        },
        "tags": {
          "type": "array",
          "description": "Tags for filtering step execution (universal)",
          "items": {
            "type": "string"
          }
        },
        "template": {
          "description": "Render template files and write to destination",
          "$ref": "#/definitions/template"
        },
        "timeout": {
          "type": "string",
          "description": "⚠️ SHELL/COMMAND ONLY: Maximum execution time (e.g., '30s', '5m', '1h'). Works with 'shell' and 'command' actions. Ignored for file/template/include.",
          "pattern": "^[0-9]+(ns|us|µs|ms|s|m|h)$"
        },
        "unarchive": {
          "description": "Extract archive files (tar, tar.gz, zip) with path traversal protection",
          "$ref": "#/definitions/unarchive"
        },
        "unless": {
          "type": "string",
          "description": "Skip step if this command succeeds (exit code 0). Useful for idempotency (universal)"
        },
        "vars": {
          "description": "Set variables for use in subsequent steps",
          "$ref": "#/definitions/vars"
        },
        "when": {
          "type": "string",
          "description": "Conditional expression for step execution (universal)"
        },
        "with_filetree": {
          "type": "string",
          "description": "Directory path for iterating over files (universal)"
        },
        "with_items": {
          "type": "string",
          "description": "Variable expression for iterating over items (universal)"
        }
      },
      "oneOf": [
        {
          "required": [
            "package"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "preset"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "unarchive"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "include_vars"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "print"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "service"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "shell"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "template"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "vars"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "assert"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "command"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "copy"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "download"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "file"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              }
            ]
          }
        },
        {
          "required": [
            "include"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "package"
                ]
              },
              {
                "required": [
                  "preset"
                ]
              },
              {
                "required": [
                  "unarchive"
                ]
              },
              {
                "required": [
                  "include_vars"
                ]
              },
              {
                "required": [
                  "print"
                ]
              },
              {
                "required": [
                  "service"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              },
              {
                "required": [
                  "template"
                ]
              },
              {
                "required": [
                  "vars"
                ]
              },
              {
                "required": [
                  "assert"
                ]
              },
              {
                "required": [
                  "command"
                ]
              },
              {
                "required": [
                  "copy"
                ]
              },
              {
                "required": [
                  "download"
                ]
              },
              {
                "required": [
                  "file"
                ]
              }
            ]
          }
        }
      ],
      "additionalProperties": false
    },
    "template": {
      "type": "object",
      "description": "Render template files and write to destination",
      "properties": {
        "dest": {
          "type": "string"
        },
        "mode": {
          "type": "string",
          "pattern": "^[0-7]{3,4}$"
        },
        "src": {
          "type": "string"
        },
        "vars": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "required": [
        "src",
        "dest"
      ],
      "additionalProperties": false,
      "x-implements-check": true,
      "x-category": "file",
      "x-supports-dry-run": true,
      "x-supports-become": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "template.rendered"
      ]
    },
    "unarchive": {
      "type": "object",
      "description": "Extract archive files (tar, tar.gz, zip) with path traversal protection",
      "properties": {
        "creates": {
          "type": "string"
        },
        "dest": {
          "type": "string"
        },
        "mode": {
          "type": "string",
          "pattern": "^[0-7]{3,4}$"
        },
        "src": {
          "type": "string"
        },
        "strip_components": {
          "type": "integer"
        }
      },
      "required": [
        "src",
        "dest"
      ],
      "additionalProperties": false,
      "x-implements-check": true,
      "x-category": "file",
      "x-supports-dry-run": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "archive.extracted"
      ]
    },
    "vars": {
      "type": "object",
      "description": "Define or update variables",
      "additionalProperties": true,
      "x-category": "data",
      "x-supports-dry-run": true,
      "x-version": "1.0.0",
      "x-emits-events": [
        "variables.set"
      ]
    }
  }
}
