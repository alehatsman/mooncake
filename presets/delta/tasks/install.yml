# delta Installation Tasks

- name: Check if delta is already installed
  shell: command -v delta
  register: delta_check
  failed_when: false

# macOS Installation
- name: Install delta via Homebrew (macOS)
  shell: brew install git-delta
  when: os == "darwin" and delta_check.rc != 0

# Linux Installation
- name: Install delta via package manager (Debian/Ubuntu)
  shell: |
    wget https://github.com/dandavison/delta/releases/download/0.16.5/git-delta_0.16.5_amd64.deb
    sudo dpkg -i git-delta_0.16.5_amd64.deb
    rm git-delta_0.16.5_amd64.deb
  when: os == "linux" and apt_available and delta_check.rc != 0

- name: Install delta via DNF (Fedora/RHEL)
  shell: sudo dnf install -y git-delta
  when: os == "linux" and dnf_available and delta_check.rc != 0

- name: Install delta from cargo (fallback)
  shell: cargo install git-delta
  when: os == "linux" and delta_check.rc != 0 and not apt_available and not dnf_available
  failed_when: false

# Verify installation
- name: Verify delta installation
  shell: delta --version
  register: delta_version

- name: Display delta version
  print: "delta installed: {{ delta_version.stdout }}"

# Configure git to use delta
- name: Configure git to use delta as pager
  shell: |
    git config --global core.pager "delta"
    git config --global interactive.diffFilter "delta --color-only"
    git config --global delta.navigate true
    git config --global delta.light false
    git config --global delta.line-numbers {{ parameters.line_numbers | lower }}
    git config --global delta.side-by-side {{ parameters.side_by_side | lower }}
    git config --global delta.syntax-theme "{{ parameters.theme }}"
    git config --global merge.conflictstyle diff3
    git config --global diff.colorMoved default
  when: parameters.configure_git

- name: Display delta usage information
  print: |
    delta installed successfully!

    {% if parameters.configure_git %}
    Git has been configured to use delta for:
      - git diff
      - git log
      - git show
      - git blame

    Configuration:
      Theme: {{ parameters.theme }}
      Line numbers: {{ parameters.line_numbers }}
      Side-by-side: {{ parameters.side_by_side }}
    {% else %}
    To configure git manually:
      git config --global core.pager delta
      git config --global interactive.diffFilter "delta --color-only"
    {% endif %}

    Usage:
      # Git will automatically use delta
      git diff
      git show HEAD
      git log -p

      # Use delta directly
      delta file1.txt file2.txt

      # Pipe diff output
      diff -u file1.txt file2.txt | delta

      # Compare directories
      diff -ur dir1/ dir2/ | delta

    Features:
      - Syntax highlighting
      - Line numbers (if enabled)
      - Git diff semantics
      - Side-by-side view (if enabled)
      - Navigate with n/N (if enabled)
      - Hyperlinks to files (terminal support)

    Available themes:
      - Monokai Extended (default)
      - GitHub
      - Nord
      - Dracula
      - Solarized (dark)
      - Base16
      - gruvbox
      - OneHalfDark

    Change theme:
      git config --global delta.syntax-theme "GitHub"

    Toggle features:
      git config --global delta.line-numbers true
      git config --global delta.side-by-side true
      git config --global delta.navigate true

    View all settings:
      git config --global --get-regexp delta

    More info: https://github.com/dandavison/delta
