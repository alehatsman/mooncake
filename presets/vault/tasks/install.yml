# Vault Installation Tasks

- name: Check if Vault is already installed
  shell: command -v vault
  register: vault_check
  failed_when: false

# macOS Installation
- name: Tap HashiCorp repository (macOS)
  shell: brew tap hashicorp/tap
  when: os == "darwin" and vault_check.rc != 0

- name: Install Vault via Homebrew (macOS)
  package:
    name: hashicorp/tap/vault
    state: present
  when: os == "darwin" and vault_check.rc != 0

# Linux - Debian/Ubuntu
- name: Install prerequisites (Debian/Ubuntu)
  package:
    names:
      - wget
      - gpg
      - coreutils
    state: present
  become: true
  when: os == "linux" and package_manager == "apt" and vault_check.rc != 0

- name: Add HashiCorp GPG key (Debian/Ubuntu)
  shell: wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
  become: true
  when: os == "linux" and package_manager == "apt" and vault_check.rc != 0

- name: Add HashiCorp repository (Debian/Ubuntu)
  shell: echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
  become: true
  when: os == "linux" and package_manager == "apt" and vault_check.rc != 0

- name: Update apt cache (Debian/Ubuntu)
  shell: apt-get update
  become: true
  when: os == "linux" and package_manager == "apt" and vault_check.rc != 0

- name: Install Vault (Debian/Ubuntu)
  package:
    name: vault
    state: present
  become: true
  when: os == "linux" and package_manager == "apt" and vault_check.rc != 0

# Linux - RHEL/Fedora
- name: Add HashiCorp repository (RHEL/Fedora)
  shell: |
    dnf config-manager --add-repo https://rpm.releases.hashicorp.com/fedora/hashicorp.repo
  become: true
  when: os == "linux" and package_manager == "dnf" and vault_check.rc != 0

- name: Install Vault (RHEL/Fedora)
  package:
    name: vault
    state: present
  become: true
  when: os == "linux" and package_manager == "dnf" and vault_check.rc != 0

# Verify installation
- name: Verify Vault installation
  shell: vault version
  register: vault_version

- name: Display Vault version
  print: "Vault installed: {{ vault_version.stdout }}"
