# Rust/rustup Installation

# Check if rustup is already installed
- name: Check if rustup is installed
  shell: command -v rustup
  register: rustup_installed
  failed_when: false

# Install rustup on Linux/macOS
- name: Install rustup (Linux/macOS)
  shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
    sh -s -- -y --profile {{ parameters.profile }} --default-toolchain {{ parameters.toolchain }}
  when: os in ["linux", "darwin"] and rustup_installed.rc != 0

# Create cargo environment init file
- name: Create cargo env init file
  shell: |
    cat > "$HOME/.cargo_init" << 'EOF'
    # Rust/Cargo configuration
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    EOF
    chmod 0644 "$HOME/.cargo_init"
  when: rustup_installed.rc != 0

# Add cargo env to shell profiles
- name: Add cargo env to shell profiles
  shell: |
    for profile in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile"; do
      if [ -f "$profile" ] && ! grep -q '.cargo_init' "$profile"; then
        echo '[ -f "$HOME/.cargo_init" ] && source "$HOME/.cargo_init"' >> "$profile"
      fi
    done
  when: rustup_installed.rc != 0

# Source cargo env for current execution
- name: Install Rust toolchain {{ parameters.toolchain }}
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup toolchain install {{ parameters.toolchain }}

# Set default toolchain
- name: Set {{ parameters.toolchain }} as default toolchain
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup default {{ parameters.toolchain }}
  when: parameters.set_default

# Install additional components
- name: Install Rust component {{ item }}
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup component add {{ item }}
  with_items: parameters.components
  when: parameters.components | length > 0

# Install compilation targets
- name: Install Rust target {{ item }}
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup target add {{ item }}
  with_items: parameters.targets
  when: parameters.targets | length > 0

# Verify installation
- name: Verify Rust installation
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustc --version
  register: rustc_version

- name: Verify Cargo installation
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    cargo --version
  register: cargo_version

- name: List installed toolchains
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup toolchain list
  register: toolchains

- name: List installed components
  shell: |
    [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
    rustup component list --installed
  register: components_installed

- name: Verify installation with assert
  assert:
    command:
      cmd: command -v rustc
      exit_code: 0

- name: Print installation summary
  print: |
    Rust installed successfully!

    Rust compiler: {{ rustc_version.stdout }}
    Cargo: {{ cargo_version.stdout }}

    Installed toolchains:
    {{ toolchains.stdout }}

    Installed components:
    {{ components_installed.stdout }}

    To use Rust in new shells, restart your terminal or run:
      source ~/.cargo/env

    Available commands:
      rustc             # Rust compiler
      cargo             # Package manager and build tool
      rustup            # Toolchain manager
      cargo new myapp   # Create new project
      cargo build       # Build project
      cargo run         # Run project
