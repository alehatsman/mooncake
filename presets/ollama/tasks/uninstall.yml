# Ollama Uninstallation Tasks
# Handles service cleanup and binary removal

- name: Stop Ollama service (Linux)
  service:
    name: ollama
    state: stopped
    enabled: false
  become: true
  when: (parameters.state == "absent") and (os == "linux")
  failed_when: false

- name: Stop Ollama service (macOS)
  shell: |
    launchctl bootout gui/$(id -u)/com.ollama 2>/dev/null || true
    launchctl unload ~/Library/LaunchAgents/com.ollama.plist 2>/dev/null || true
  when: (parameters.state == "absent") and (os == "darwin")
  failed_when: false

- name: Uninstall Ollama via package manager
  package:
    name: ollama
    state: absent
  become: true
  when: (parameters.state == "absent") and (parameters.method == "package")
  failed_when: false

- name: Remove Ollama binary (script installation)
  shell: rm -f /usr/local/bin/ollama /usr/bin/ollama
  become: true
  when: (parameters.state == "absent") and (parameters.method != "package")
  failed_when: false

- name: Remove Ollama models directory (if force)
  file:
    path: "{% if parameters.models_dir %}{{ parameters.models_dir }}{% else %}~/.ollama{% endif %}"
    state: absent
  when: (parameters.state == "absent") and (parameters.force)
  failed_when: false

- name: Assert tool is removed
  assert:
    command:
      cmd: command -v ollama
      exit_code: 1
  when: parameters.state == "absent"
