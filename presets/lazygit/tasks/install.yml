# lazygit Installation Tasks

- name: Check if lazygit is already installed
  shell: command -v lazygit
  register: lazygit_check
  failed_when: false

# macOS Installation
- name: Install lazygit via Homebrew (macOS)
  shell: brew install lazygit
  when: os == "darwin" and lazygit_check.rc != 0

# Linux Installation
- name: Download and install lazygit (Linux)
  shell: |
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit /usr/local/bin
    rm lazygit lazygit.tar.gz
  when: os == "linux" and lazygit_check.rc != 0

# Verify installation
- name: Verify lazygit installation
  shell: lazygit --version
  register: lazygit_version

- name: Display lazygit version
  print: "lazygit installed: {{ lazygit_version.stdout }}"

# Create config directory
- name: Create lazygit config directory
  file:
    path: ~/.config/lazygit
    state: directory
    mode: "0755"
  when: parameters.create_config

# Create default configuration
- name: Create lazygit configuration
  file:
    path: ~/.config/lazygit/config.yml
    content: |
      gui:
        # Theme
        theme:
          lightTheme: false
          activeBorderColor:
            - green
            - bold
          inactiveBorderColor:
            - white
        # Show file icons
        showFileTree: true
        showRandomTip: true
        showCommandLog: true
        commandLogSize: 8

      git:
        paging:
          colorArg: always
          pager: delta --dark --paging=never

        commit:
          signOff: false

        merging:
          # Only display conflicts
          manualCommit: false
          args: ''

        log:
          # Show graph in log view
          showGraph: 'always'
          order: 'topo-order'

        skipHookPrefix: WIP

        autoFetch: true
        autoRefresh: true
        branchLogCmd: 'git log --graph --color=always --abbrev-commit --decorate --date=relative --pretty=medium {{branchName}} --'

      update:
        method: prompt

      refresher:
        refreshInterval: 10
        fetchInterval: 60

      confirmOnQuit: false

      # Keybindings
      keybinding:
        universal:
          quit: 'q'
          quit-alt1: '<c-c>'
          return: '<esc>'
          quitWithoutChangingDirectory: 'Q'
          togglePanel: '<tab>'
          prevItem: '<up>'
          nextItem: '<down>'
          prevItem-alt: 'k'
          nextItem-alt: 'j'
          prevPage: ','
          nextPage: '.'
          gotoTop: '<'
          gotoBottom: '>'
          scrollLeft: 'H'
          scrollRight: 'L'
          prevBlock: '<left>'
          nextBlock: '<right>'
          prevBlock-alt: 'h'
          nextBlock-alt: 'l'
          jumpToBlock: ['1', '2', '3', '4', '5']
          nextMatch: 'n'
          prevMatch: 'N'
          optionMenu: 'x'
          optionMenu-alt1: '?'
          select: '<space>'
          goInto: '<enter>'
          openRecentRepos: '<c-r>'
          confirm: '<enter>'
          remove: 'd'
          new: 'n'
          edit: 'e'
          openFile: 'o'
          scrollUpMain: '<pgup>'
          scrollDownMain: '<pgdown>'
          scrollUpMain-alt1: 'K'
          scrollDownMain-alt1: 'J'
          scrollUpMain-alt2: '<c-u>'
          scrollDownMain-alt2: '<c-d>'
          executeCustomCommand: ':'
          createRebaseOptionsMenu: 'm'
          pushFiles: 'P'
          pullFiles: 'p'
          refresh: 'R'
          createPatchOptionsMenu: '<c-p>'
          nextTab: ']'
          prevTab: '['
          nextScreenMode: '+'
          prevScreenMode: '_'
          undo: 'z'
          redo: '<c-z>'
          filteringMenu: '<c-s>'
          diffingMenu: 'W'
          diffingMenu-alt: '<c-e>'
          copyToClipboard: '<c-o>'
          submitEditorText: '<enter>'
          extrasMenu: '@'
          toggleWhitespaceInDiffView: '<c-w>'
          increaseContextInDiffView: '}'
          decreaseContextInDiffView: '{'
    mode: "0644"
  when: parameters.create_config

- name: Display lazygit usage information
  print: |
    lazygit installed successfully!

    Usage:
      # Launch in current git repo
      lazygit

      # Launch in specific repo
      lazygit -p ~/myproject

    Key features:
      - Stage/unstage files and hunks
      - Commit with Ctrl+C or 'c'
      - Push/pull with 'P'/'p'
      - Create/checkout branches
      - Interactive rebase
      - Merge and rebase workflows
      - Stash management
      - View commit history and diffs
      - Cherry-pick commits

    Navigation:
      Tab       - Switch between panels
      j/k       - Move up/down
      h/l       - Switch panels left/right
      Enter     - Select/view details
      Space     - Stage/unstage
      c         - Commit
      P         - Push
      p         - Pull
      R         - Refresh
      x         - Open menu
      ?         - Help

    Configuration: ~/.config/lazygit/config.yml

    More info: https://github.com/jesseduffield/lazygit
