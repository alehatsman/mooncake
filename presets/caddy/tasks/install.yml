# Caddy Installation Tasks

- name: Check if Caddy is already installed
  shell: command -v caddy
  register: caddy_check
  failed_when: false

# macOS Installation
- name: Install Caddy via Homebrew via Homebrew
  package:
    name: caddy
    state: present
  when: brew_available and caddy_check.rc != 0

# Linux - Debian/Ubuntu
- name: Install prerequisites (Debian/Ubuntu)
  package:
    names:
      - debian-keyring
      - debian-archive-keyring
      - apt-transport-https
      - curl
    state: present
  become: true
  when: apt_available and caddy_check.rc != 0

- name: Add Caddy GPG key (Debian/Ubuntu)
  shell: curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  become: true
  when: apt_available and caddy_check.rc != 0

- name: Add Caddy repository (Debian/Ubuntu)
  shell: |
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
  become: true
  when: apt_available and caddy_check.rc != 0

- name: Update apt cache (Debian/Ubuntu)
  shell: apt-get update
  become: true
  when: apt_available and caddy_check.rc != 0

- name: Install Caddy (Debian/Ubuntu)
  package:
    name: caddy
    state: present
  become: true
  when: apt_available and caddy_check.rc != 0

# Linux - Fedora/RHEL
- name: Add Caddy repository (Fedora/RHEL)
  shell: |
    dnf install 'dnf-command(copr)' -y
    dnf copr enable @caddy/caddy -y
  become: true
  when: dnf_available and caddy_check.rc != 0

- name: Install Caddy (Fedora/RHEL)
  package:
    name: caddy
    state: present
  become: true
  when: dnf_available and caddy_check.rc != 0

- name: Verify installation with assert
  assert:
    command:
      cmd: command -v caddy
      exit_code: 0

- name: Display confirmation
  print: "caddy installed"
