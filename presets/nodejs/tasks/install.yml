# Node.js/nvm Installation

# Check if nvm is already installed
- name: Check if nvm is installed
  assert:
    file:
      path: "~/.nvm/nvm.sh"
      exists: true
  register: nvm_installed
  failed_when: false

# Install nvm on Linux/macOS
- name: Install nvm (Linux/macOS)
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  when: os in ["linux", "darwin"] and nvm_installed.failed

# Create nvm initialization file
- name: Create nvm init file
  file:
    path: "~/.nvm_init"
    content: |
      # nvm configuration
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    mode: "0644"
  when: os in ["linux", "darwin"] and nvm_installed.failed

# Add nvm init to shell profiles
- name: Add nvm to shell profile
  shell: |
    for profile in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.profile"; do
      if [ -f "$profile" ] && ! grep -q '.nvm_init' "$profile"; then
        echo '[ -f "$HOME/.nvm_init" ] && source "$HOME/.nvm_init"' >> "$profile"
      fi
    done
  when: os in ["linux", "darwin"] and nvm_installed.failed

# Install Node.js version
- name: Install Node.js {{ parameters.version }}
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install {{ parameters.version }}
  creates: "~/.nvm/versions/node"

# Set default version
- name: Set Node.js {{ parameters.version }} as default
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm alias default {{ parameters.version }}
  when: parameters.set_default

# Install additional versions
- name: Install additional Node.js version {{ item }}
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install {{ item }}
  with_items: parameters.additional_versions
  when: parameters.additional_versions | length > 0

# Install global npm packages
- name: Install global npm package {{ item }}
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    npm install -g {{ item }}
  with_items: parameters.global_packages
  when: parameters.global_packages | length > 0

# Verify installation
- name: Verify Node.js installation
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    node --version
  register: node_version

- name: Verify npm installation
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    npm --version
  register: npm_version

- name: Print installation summary
  print: |
    Node.js installed successfully!

    Node version: {{ node_version.stdout }}
    npm version: {{ npm_version.stdout }}

    To use Node.js in new shells, restart your terminal or run:
      source ~/.bashrc  # or ~/.zshrc

    Available commands:
      node              # Run Node.js
      npm               # Node package manager
      nvm ls            # List installed versions
      nvm use <version> # Switch Node.js version
