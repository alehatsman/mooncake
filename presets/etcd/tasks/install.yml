# etcd Installation Tasks

- name: Check if etcd is already installed
  shell: command -v etcd
  register: etcd_check
  failed_when: false

# macOS Installation
- name: Install etcd via Homebrew (macOS)
  shell: brew install etcd
  when: os == "darwin" and etcd_check.rc != 0

# Linux Installation
- name: Download and install etcd (Linux)
  shell: |
    ETCD_VERSION="{{ parameters.version }}"
    if [ "$ETCD_VERSION" = "latest" ]; then
      ETCD_VERSION=$(curl -s https://api.github.com/repos/etcd-io/etcd/releases/latest | grep tag_name | cut -d '"' -f 4)
    fi

    wget "https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz" -O /tmp/etcd.tar.gz
    tar -xzf /tmp/etcd.tar.gz -C /tmp/
    sudo mv /tmp/etcd-${ETCD_VERSION}-linux-amd64/etcd /usr/local/bin/
    sudo mv /tmp/etcd-${ETCD_VERSION}-linux-amd64/etcdctl /usr/local/bin/
    sudo mv /tmp/etcd-${ETCD_VERSION}-linux-amd64/etcdutl /usr/local/bin/
    sudo chmod +x /usr/local/bin/etcd /usr/local/bin/etcdctl /usr/local/bin/etcdutl
    rm -rf /tmp/etcd.tar.gz /tmp/etcd-${ETCD_VERSION}-linux-amd64
  when: os == "linux" and etcd_check.rc != 0

# Verify installation
- name: Verify etcd installation
  shell: etcd --version
  register: etcd_version

- name: Display etcd version
  print: "etcd installed: {{ etcd_version.stdout }}"

# Create data directory
- name: Create etcd data directory
  file:
    path: "{{ parameters.data_dir }}"
    state: directory
    mode: "0755"
  become: true

# Create config directory
- name: Create etcd config directory
  file:
    path: /etc/etcd
    state: directory
    mode: "0755"
  become: true

# Create configuration file
- name: Create etcd configuration
  file:
    path: /etc/etcd/etcd.conf.yml
    content: |
      # Member configuration
      name: 'default'
      data-dir: {{ parameters.data_dir }}

      # Client URLs
      listen-client-urls: http://0.0.0.0:{{ parameters.client_port }}
      advertise-client-urls: http://localhost:{{ parameters.client_port }}

      # Peer URLs (for clustering)
      listen-peer-urls: http://0.0.0.0:{{ parameters.peer_port }}
      initial-advertise-peer-urls: http://localhost:{{ parameters.peer_port }}
      initial-cluster: 'default=http://localhost:{{ parameters.peer_port }}'
      initial-cluster-token: 'etcd-cluster'
      initial-cluster-state: 'new'

      # Logging
      log-level: 'info'
      logger: 'zap'
    mode: "0644"
  become: true

# Create systemd service (Linux)
- name: Create etcd systemd service
  file:
    path: /etc/systemd/system/etcd.service
    content: |
      [Unit]
      Description=etcd key-value store
      Documentation=https://etcd.io
      After=network.target

      [Service]
      Type=notify
      ExecStart=/usr/local/bin/etcd --config-file /etc/etcd/etcd.conf.yml
      Restart=on-failure
      RestartSec=5
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
    mode: "0644"
  become: true
  when: os == "linux"

# Reload systemd
- name: Reload systemd daemon
  shell: sudo systemctl daemon-reload
  when: os == "linux"

# Start service
- name: Start etcd service
  service:
    name: etcd
    state: started
    enabled: true
  become: true
  when: parameters.start_service and os == "linux"

# macOS service instructions
- name: Display macOS service instructions
  print: |
    etcd installed successfully!

    Start etcd (macOS):
      etcd

      # Or as service
      brew services start etcd
  when: os == "darwin"

- name: Display etcd usage
  print: |
    etcd installed successfully!

    Configuration: /etc/etcd/etcd.conf.yml
    Data directory: {{ parameters.data_dir }}
    Client port: {{ parameters.client_port }}
    Peer port: {{ parameters.peer_port }}

    {% if os == "linux" %}
    Service management:
      sudo systemctl start etcd
      sudo systemctl status etcd
      sudo journalctl -u etcd -f
    {% endif %}

    Basic operations (etcdctl):
      # Set a key
      etcdctl put mykey "Hello World"

      # Get a key
      etcdctl get mykey

      # Delete a key
      etcdctl del mykey

      # List all keys
      etcdctl get "" --prefix --keys-only

      # Watch key changes
      etcdctl watch mykey

      # Check cluster health
      etcdctl endpoint health

      # List members
      etcdctl member list

    Environment setup:
      export ETCDCTL_API=3
      export ETCDCTL_ENDPOINTS=http://localhost:{{ parameters.client_port }}

    More info: https://etcd.io/docs/
