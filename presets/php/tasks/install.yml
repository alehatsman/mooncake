# PHP Installation Tasks

- name: Check if PHP is already installed
  shell: command -v php
  register: php_check
  failed_when: false

# macOS Installation
- name: Install PHP via Homebrew (macOS)
  shell: brew install php@{{ parameters.version }}
  when: os == "darwin" and php_check.rc != 0

- name: Link PHP (macOS)
  shell: brew link --force --overwrite php@{{ parameters.version }}
  when: os == "darwin" and php_check.rc != 0
  failed_when: false

# Linux - Debian/Ubuntu
- name: Add PHP repository (Debian/Ubuntu)
  shell: |
    sudo add-apt-repository -y ppa:ondrej/php
    sudo apt-get update
  become: true
  when: os == "linux" and package_manager == "apt" and php_check.rc != 0

- name: Install PHP (Debian/Ubuntu)
  package:
    name: "php{{ parameters.version }}"
    state: present
  become: true
  when: os == "linux" and package_manager == "apt" and php_check.rc != 0

# Linux - RHEL/Fedora
- name: Install PHP (RHEL/Fedora)
  package:
    name: php
    state: present
  become: true
  when: os == "linux" and package_manager in ["dnf", "yum"] and php_check.rc != 0

# Install extensions
- name: Install PHP extensions (macOS)
  shell: brew install php@{{ parameters.version }}-{{ item }}
  with_items: parameters.extensions
  when: os == "darwin" and parameters.extensions | length > 0
  failed_when: false

- name: Install PHP extensions (Linux)
  package:
    name: "php{{ parameters.version }}-{{ item }}"
    state: present
  become: true
  with_items: parameters.extensions
  when: os == "linux" and parameters.extensions | length > 0

# Verify installation
- name: Verify PHP installation
  shell: php -v | head -1
  register: php_version

- name: Display PHP version
  print: "PHP installed: {{ php_version.stdout }}"

# Install Composer
- name: Check if Composer is installed
  shell: command -v composer
  register: composer_check
  failed_when: false
  when: parameters.install_composer

- name: Download Composer installer
  shell: curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php
  when: parameters.install_composer and composer_check.rc != 0

- name: Install Composer
  shell: |
    php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
    rm /tmp/composer-setup.php
  become: true
  when: parameters.install_composer and composer_check.rc != 0

- name: Verify Composer installation
  shell: composer --version
  register: composer_version
  when: parameters.install_composer

- name: Display Composer version
  print: "{{ composer_version.stdout }}"
  when: parameters.install_composer

- name: Display installation summary
  print: |
    PHP {{ parameters.version }} installed successfully!
    {{ "Composer installed" if parameters.install_composer else "" }}
    {{ "Extensions: " + (parameters.extensions | join(", ")) if parameters.extensions | length > 0 else "" }}

    Test PHP:
      php -r "echo 'Hello from PHP ' . PHP_VERSION . PHP_EOL;"

    {{ "Create project with Composer: composer create-project" if parameters.install_composer else "" }}
