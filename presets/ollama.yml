preset:
  name: ollama
  description: Install and manage Ollama LLM runtime
  version: 1.0.0

  parameters:
    state:
      type: string
      required: true
      default: present
      enum: [present, absent]
      description: Whether Ollama should be installed or removed

    pull:
      type: array
      required: false
      default: []
      description: List of models to pull (e.g., ['llama3.1:8b', 'mistral'])

    service:
      type: bool
      required: false
      default: true
      description: Enable and start Ollama service

    method:
      type: string
      required: false
      default: auto
      enum: [auto, script, package]
      description: Installation method (auto, script, package)

    host:
      type: string
      required: false
      description: Ollama server bind address (e.g., 'localhost:11434', '0.0.0.0:11434')

    models_dir:
      type: string
      required: false
      description: Custom models directory path

    force:
      type: bool
      required: false
      default: false
      description: Force operations (re-pull models, remove models on uninstall)

  steps:
    # ========================================
    # INSTALLATION (state: present)
    # ========================================

    - name: Check if Ollama is already installed
      shell: command -v ollama
      register: ollama_check
      failed_when: false
      when: parameters.state == "present"

    # Try package manager installation (auto or package method)
    - name: Install Ollama via apt (Debian/Ubuntu)
      shell: apt-get update && apt-get install -y ollama
      become: true
      when: >
        parameters.state == "present" and
        ollama_check.rc != 0 and
        (parameters.method == "auto" or parameters.method == "package") and
        apt_available and
        os == "linux"
      register: apt_install
      failed_when: false

    - name: Install Ollama via dnf (Fedora/RHEL 8+)
      shell: dnf install -y ollama
      become: true
      when: >
        parameters.state == "present" and
        ollama_check.rc != 0 and
        (parameters.method == "auto" or parameters.method == "package") and
        dnf_available and
        os == "linux" and
        (apt_install is undefined or apt_install.rc != 0)
      register: dnf_install
      failed_when: false

    - name: Install Ollama via yum (RHEL/CentOS 7)
      shell: yum install -y ollama
      become: true
      when: >
        parameters.state == "present" and
        ollama_check.rc != 0 and
        (parameters.method == "auto" or parameters.method == "package") and
        yum_available and
        os == "linux" and
        (apt_install is undefined or apt_install.rc != 0) and
        (dnf_install is undefined or dnf_install.rc != 0)
      register: yum_install
      failed_when: false

    - name: Install Ollama via Homebrew (macOS)
      shell: brew install ollama
      when: >
        parameters.state == "present" and
        ollama_check.rc != 0 and
        (parameters.method == "auto" or parameters.method == "package") and
        brew_available and
        os == "darwin"
      register: brew_install
      failed_when: false

    # Fallback to script installation
    - name: Install Ollama via official script
      shell: curl -fsSL https://ollama.com/install.sh | sh
      become: true
      when: >
        parameters.state == "present" and
        ollama_check.rc != 0 and
        (parameters.method == "auto" or parameters.method == "script") and
        (apt_install is undefined or apt_install.rc != 0) and
        (dnf_install is undefined or dnf_install.rc != 0) and
        (yum_install is undefined or yum_install.rc != 0) and
        (brew_install is undefined or brew_install.rc != 0)

    # ========================================
    # SERVICE CONFIGURATION
    # ========================================

    - name: Configure Ollama systemd service (Linux)
      service:
        name: ollama
        state: started
        enabled: true
        daemon_reload: true
        dropin:
          name: 10-mooncake.conf
          content: |
            [Service]
            {% if parameters.host %}Environment="OLLAMA_HOST={{ parameters.host }}"{% endif %}
            {% if parameters.models_dir %}Environment="OLLAMA_MODELS={{ parameters.models_dir }}"{% endif %}
      become: true
      when: >
        parameters.state == "present" and
        parameters.service and
        os == "linux"

    - name: Configure Ollama launchd service (macOS)
      service:
        name: ollama
        state: started
        enabled: true
        unit:
          content: |
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
              <key>Label</key>
              <string>com.ollama.ollama</string>
              <key>ProgramArguments</key>
              <array>
                <string>/usr/local/bin/ollama</string>
                <string>serve</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              {% if parameters.host or parameters.models_dir %}
              <key>EnvironmentVariables</key>
              <dict>
                {% if parameters.host %}
                <key>OLLAMA_HOST</key>
                <string>{{ parameters.host }}</string>
                {% endif %}
                {% if parameters.models_dir %}
                <key>OLLAMA_MODELS</key>
                <string>{{ parameters.models_dir }}</string>
                {% endif %}
              </dict>
              {% endif %}
            </dict>
            </plist>
      when: >
        parameters.state == "present" and
        parameters.service and
        os == "darwin"

    # ========================================
    # MODEL MANAGEMENT
    # ========================================

    - name: Pull Ollama models
      shell: |
        {% for model in parameters.pull %}
        # Check if model exists (unless force)
        {% if not parameters.force %}
        if ollama list | grep -q "{{ model }}"; then
          echo "Model {{ model }} already exists, skipping"
        else
          echo "Pulling model {{ model }}"
          ollama pull {{ model }}
        fi
        {% else %}
        echo "Force pulling model {{ model }}"
        ollama pull {{ model }}
        {% endif %}
        {% endfor %}
      when: >
        parameters.state == "present" and
        parameters.pull | length > 0
      register: model_pull

    # ========================================
    # UNINSTALLATION (state: absent)
    # ========================================

    - name: Check if Ollama is installed (for removal)
      shell: command -v ollama
      register: ollama_removal_check
      failed_when: false
      when: parameters.state == "absent"

    - name: Stop Ollama service (Linux)
      service:
        name: ollama
        state: stopped
        enabled: false
      become: true
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0 and
        os == "linux"
      failed_when: false

    - name: Stop Ollama service (macOS)
      service:
        name: ollama
        state: stopped
        enabled: false
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0 and
        os == "darwin"
      failed_when: false

    - name: Remove Ollama via apt
      shell: apt-get remove -y ollama
      become: true
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0 and
        apt_available and
        os == "linux"
      failed_when: false

    - name: Remove Ollama via dnf
      shell: dnf remove -y ollama
      become: true
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0 and
        dnf_available and
        os == "linux"
      failed_when: false

    - name: Remove Ollama via Homebrew
      shell: brew uninstall ollama
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0 and
        brew_available and
        os == "darwin"
      failed_when: false

    - name: Remove Ollama binary (script installation)
      shell: rm -f /usr/local/bin/ollama /usr/bin/ollama
      become: true
      when: >
        parameters.state == "absent" and
        ollama_removal_check.rc == 0
      failed_when: false

    - name: Remove Ollama models directory (if force)
      file:
        path: "{% if parameters.models_dir %}{{ parameters.models_dir }}{% else %}~/.ollama{% endif %}"
        state: absent
      when: >
        parameters.state == "absent" and
        parameters.force
      failed_when: false
