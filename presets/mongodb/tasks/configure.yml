# MongoDB Configuration Tasks

- name: Ensure data directory exists
  file:
    path: "{{ parameters.data_dir }}"
    state: directory
    mode: "0755"
  become: true
  when: linux

- name: Start MongoDB service (Linux)
  service:
    name: mongod
    state: started
    enabled: true
  become: true
  when: linux and parameters.start_service

- name: Start MongoDB service (macOS)
  shell: brew services start mongodb-community
  when: brew_available and parameters.start_service

- name: Wait for MongoDB to be ready
  shell: mongosh --eval "db.adminCommand('ping')" --quiet
  register: mongodb_ready
  until: mongodb_ready.rc == 0
  retries: 10
  delay: 2
  failed_when: false

- name: Verify MongoDB is running
  shell: mongosh --eval "db.version()" --quiet
  register: mongodb_status
  failed_when: false

- name: Display MongoDB status
  print: "MongoDB is running: {{ mongodb_status.stdout }}"
  when: mongodb_status.rc == 0
