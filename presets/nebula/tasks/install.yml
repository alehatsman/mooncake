- name: Check if nebula is installed
  shell: command -v nebula
  register: nebula_check
  failed_when: false

- name: Install nebula via Homebrew
  package:
    name: nebula
    state: present
  when: brew_available and nebula_check.rc != 0

- name: Install nebula via GitHub release
  shell: |
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
    if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi
    curl -sL https://github.com/slackhq/nebula/releases/latest/download/nebula-linux-${ARCH}.tar.gz | tar xz
    sudo mv nebula /usr/local/bin/
    sudo mv nebula-cert /usr/local/bin/
    sudo chmod +x /usr/local/bin/nebula /usr/local/bin/nebula-cert
  when: linux and nebula_check.rc != 0

- name: Verify installation with assert
  assert:
    command:
      cmd: command -v nebula
      exit_code: 0

- name: Display confirmation
  print: "nebula installed"
