# Grafana Installation Tasks

- name: Check if Grafana is already installed
  shell: command -v grafana-server
  register: grafana_check
  failed_when: false

# macOS Installation
- name: Install Grafana via Homebrew (macOS)
  package:
    name: grafana
    state: present
  when: brew_available and grafana_check.rc != 0

# Linux - Debian/Ubuntu
- name: Install prerequisites (Debian/Ubuntu)
  package:
    names:
      - apt-transport-https
      - software-properties-common
      - wget
    state: present
  become: true
  when: apt_available and grafana_check.rc != 0

- name: Add Grafana GPG key (Debian/Ubuntu)
  shell: wget -q -O - https://packages.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/trusted.gpg.d/grafana.gpg > /dev/null
  become: true
  when: apt_available and grafana_check.rc != 0

- name: Add Grafana repository (Debian/Ubuntu)
  shell: echo "deb https://packages.grafana.com/oss/deb stable main" | tee /etc/apt/sources.list.d/grafana.list
  become: true
  when: apt_available and grafana_check.rc != 0

- name: Update apt cache (Debian/Ubuntu)
  shell: apt-get update
  become: true
  when: apt_available and grafana_check.rc != 0

- name: Install Grafana (Debian/Ubuntu)
  package:
    name: grafana
    state: present
  become: true
  when: apt_available and grafana_check.rc != 0

# Linux - RHEL/Fedora
- name: Add Grafana repository (RHEL/Fedora)
  shell: |
    cat > /etc/yum.repos.d/grafana.repo <<EOF
    [grafana]
    name=grafana
    baseurl=https://packages.grafana.com/oss/rpm
    repo_gpgcheck=1
    enabled=1
    gpgcheck=1
    gpgkey=https://packages.grafana.com/gpg.key
    sslverify=1
    sslcacert=/etc/pki/tls/certs/ca-bundle.crt
    EOF
  become: true
  when: dnf_available or yum_available and grafana_check.rc != 0

- name: Install Grafana (RHEL/Fedora)
  package:
    name: grafana
    state: present
  become: true
  when: dnf_available or yum_available and grafana_check.rc != 0

# Verify installation
- name: Verify installation with assert
  assert:
    command:
      cmd: command -v grafana-server
      exit_code: 0

- name: Display confirmation
  print: "Grafana installed"
