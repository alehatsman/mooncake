# PostgreSQL Installation Tasks

- name: Check if PostgreSQL is already installed
  shell: command -v psql
  register: postgres_check
  failed_when: false

# macOS Installation
- name: Install PostgreSQL via Homebrew (macOS)
  shell: brew install postgresql@{{ parameters.version }}
  become: false
  when: brew_available and postgres_check.rc != 0

# Linux - Debian/Ubuntu
- name: Install PostgreSQL (Debian/Ubuntu)
  shell: apt-get install -y postgresql-{{ parameters.version }} postgresql-contrib-{{ parameters.version }} postgresql-client-{{ parameters.version }}
  become: true
  when: apt_available and postgres_check.rc != 0

# Linux - RHEL/Fedora
- name: Install PostgreSQL (RHEL/Fedora)
  shell: dnf install -y postgresql{{ parameters.version }} postgresql{{ parameters.version }}-server postgresql{{ parameters.version }}-contrib
  become: true
  when: dnf_available and postgres_check.rc != 0

# Initialize database (RHEL/Fedora)
- name: Initialize PostgreSQL database (RHEL/Fedora)
  shell: postgresql-setup --initdb
  become: true
  when: dnf_available and postgres_check.rc != 0
  failed_when: false

# Verify installation
- name: Verify PostgreSQL installation with assert
  assert:
    command:
      cmd: command -v psql
      exit_code: 0

- name: Get PostgreSQL version (macOS)
  shell: /opt/homebrew/opt/postgresql@{{ parameters.version }}/bin/psql --version || /usr/local/opt/postgresql@{{ parameters.version }}/bin/psql --version
  register: postgres_version
  when: brew_available

- name: Get PostgreSQL version (Linux)
  shell: psql --version
  register: postgres_version
  when: linux

- name: Display PostgreSQL version
  print: "PostgreSQL installed: {{ postgres_version.stdout }}"
